if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=new URL(".",import.meta.url).pathname.slice(import.meta.url.match(/^file:\/\/\/\w:/)?1:0,-1)+"/";var e={};var t=undefined&&undefined.__createBinding||(Object.create?function(e,t,n,i){if(i===undefined)i=n;var r=Object.getOwnPropertyDescriptor(t,n);if(!r||("get"in r?!t.__esModule:r.writable||r.configurable)){r={enumerable:true,get:function(){return t[n]}}}Object.defineProperty(e,i,r)}:function(e,t,n,i){if(i===undefined)i=n;e[i]=t[n]});var n=undefined&&undefined.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:true,value:t})}:function(e,t){e["default"]=t});var i=undefined&&undefined.__importStar||function(e){if(e&&e.__esModule)return e;var i={};if(e!=null)for(var r in e)if(r!=="default"&&Object.prototype.hasOwnProperty.call(e,r))t(i,e,r);n(i,e);return i};var r=undefined&&undefined.__awaiter||function(e,t,n,i){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:true});const o=i(require("node:path"));const a=i(require("@actions/core"));const c=i(require("@actions/glob"));const u=require("@google-cloud/storage");const d=require("tmp-promise");const l=require("./state");const s=require("./tar-utils");function main(){return r(this,void 0,void 0,(function*(){var e;const t=(0,l.getState)();if(t.cacheHitKind==="exact"){console.log("🌀 Skipping uploading cache as the cache was hit by exact match.");return}const n=(new u.Storage).bucket(t.bucket);const i=t.targetFileName;const[f]=yield n.file(i).exists().catch((e=>{a.error("Failed to check if the file already exists");throw e}));a.debug(`Target file name: ${i}.`);if(f){console.log("🌀 Skipping uploading cache as it already exists (probably due to another job).");return}const p=(e=process.env.GITHUB_WORKSPACE)!==null&&e!==void 0?e:process.cwd();const h=yield c.create(t.path,{implicitDescendants:false});const g=yield h.glob().then((e=>e.map((e=>o.relative(p,e)))));a.debug(`Paths: ${JSON.stringify(g)}.`);return(0,d.withFile)((e=>r(this,void 0,void 0,(function*(){const t=yield a.group("🗜️ Creating cache archive",(()=>(0,s.createTar)(e.path,g,p))).catch((e=>{a.error("Failed to create the archive");throw e}));const o={"Cache-Action-Compression-Method":t};a.debug(`Metadata: ${JSON.stringify(o)}.`);yield a.group("🌐 Uploading cache archive to bucket",(()=>r(this,void 0,void 0,(function*(){console.log(`🔹 Uploading file '${i}'...`);yield n.upload(e.path,{destination:i,metadata:{metadata:o}})})))).catch((e=>{a.error("Failed to upload the file");throw e}));console.log("✅ Successfully saved cache.")}))))}))}void main().catch((e=>{a.error(e);a.setFailed(e)}));